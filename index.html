<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Granville Swimming — Apparel Order Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --pad: 14px; --radius: 12px; }
    body { font-family: system-ui, Arial, sans-serif; margin: 32px; }
    h1 { margin: 0 0 8px; }
    .subtitle { color: #555; margin-bottom: 18px; }
    .card {
      border: 1px solid #e5e5e5; border-radius: var(--radius);
      padding: var(--pad); margin-bottom: 18px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }
    label { display: block; font-weight: 600; margin-top: 10px; }
    input[type="text"], input[type="number"], input[type="email"], input[type="tel"], select {
      width: 100%; padding: 8px; border-radius: 8px;
      border: 1px solid #dcdcdc; margin-top: 6px;
    }
    .row {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }
    .contact-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
    .row > div { min-width: 0; }
    button {
      padding: 10px 14px; border-radius: 999px; border: 1px solid #dcdcdc;
      background: #0a66ff; color: white; cursor: pointer; font-weight: 600;
    }
    button.secondary { background: white; color: #333; }
    button.link { background: transparent; border: none; color: #0a66ff; padding: 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; }
    th { background: #fafafa; }
    tfoot td { font-weight: 700; }
    .right { text-align: right; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
    .note { color: #666; font-size: 0.95rem; }
  </style>
</head>
<body>
  <h1>Granville Swimming</h1>
  <div class="subtitle">Team Apparel Order Form</div>

  <div class="card">
    <h2 style="margin:0 0 8px; font-size:1.1rem;">Instructions</h2>
    <p class="note" style="margin:0 0 8px; color:#333;">
      Please input a parent name, the swimmer name or names, and an email or cell in case we need to contact you. Choose your
      items, the sizes, and colors and click the Add to Order button. If you add something you do not want, you can click
      Remove next to the item and remove it or Reset Order to remove all items.
    </p>
    <p class="note" style="margin:0; color:#333;">
      When your order is complete, push Complete Order to send the order to the team. You can push Print / Save PDF to save a
      copy of your order. All orders are due by November 7. If you have questions, please contact Alison Bergstrom
      (740-971-1223) or Julie Largent (614-403-8630).
    </p>
  </div>

  <div class="card">
    <div class="contact-grid">
      <div>
        <label for="parentName">Parent Name</label>
        <input type="text" id="parentName" placeholder="Parent name" autocomplete="name" />
      </div>
      <div>
        <label for="swimmerNames">Swimmer Name(s)</label>
        <input type="text" id="swimmerNames" placeholder="Swimmer name(s)" autocomplete="off" />
      </div>
      <div>
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="name@example.com" autocomplete="email" />
      </div>
      <div>
        <label for="cell">Cell</label>
        <input type="tel" id="cell" placeholder="555-555-5555" autocomplete="tel" />
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <label for="item">Item</label>
        <select id="item"></select>
      </div>
      <div>
        <label for="color">Color</label>
        <select id="color"></select>
      </div>
      <div>
        <label for="size">Size</label>
        <select id="size"></select>
        <div class="note" style="margin-top:4px">XXL and XXXL add $3.</div>
      </div>
      <div>
        <label for="qty">Quantity</label>
        <input type="number" id="qty" value="1" min="1" step="1" />
      </div>
      <div style="display:flex; align-items:end;">
        <button id="addBtn" type="button" title="Add this item to the order">Add to Order</button>
      </div>
    </div>
    <div class="actions">
      <button id="resetBtn" class="secondary" type="button">Reset Order</button>
      <button id="printBtn" class="secondary" type="button">Print / Save PDF</button>
      <button id="saveDropboxBtn" class="secondary" type="button">Complete Order</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Order Summary</h3>
    <div class="note">Click “Remove” to delete a line.</div>
    <table id="orderTable" aria-label="Order items">
      <thead>
        <tr>
          <th>Item</th>
          <th>Color</th>
          <th>Size</th>
          <th class="right">Qty</th>
          <th class="right">Price Each</th>
          <th class="right">Line Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="orderBody">
        <!-- rows injected here -->
      </tbody>
      <tfoot>
        <tr>
          <td colspan="5" class="right">Grand Total</td>
          <td class="right" id="grandTotal">$0.00</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="card">
    <h3 style="margin-top:0">Submit / Share</h3>
    <p class="note">
      You can print this page as a PDF and email it, or use the CSV to consolidate orders.
      If you plan to collect payments, we can add a simple payment note or QR code here.
    </p>
  </div>

  <script>
    (function () {
      const parentNameEl = document.getElementById('parentName');
      const swimmerNamesEl = document.getElementById('swimmerNames');
      const emailEl = document.getElementById('email');
      const cellEl = document.getElementById('cell');
      const itemEl = document.getElementById('item');
      const colorEl = document.getElementById('color');
      const sizeEl = document.getElementById('size');
      const qtyEl  = document.getElementById('qty');
      const addBtn = document.getElementById('addBtn');
      const resetBtn = document.getElementById('resetBtn');
      const printBtn = document.getElementById('printBtn');
      const saveDropboxBtn = document.getElementById('saveDropboxBtn');

      const orderBody = document.getElementById('orderBody');
      const grandTotalEl = document.getElementById('grandTotal');

      const SURCHARGE_SIZES = {
        XXL: 3,
        XXXL: 3
      };

      const ITEMS = [
        { id: 'team-tshirt', name: 'Team T-shirt', basePrice: 20, colors: ['Navy'], sizes: ['XS', 'S', 'M', 'L', 'XL', 'XXL', 'XXXL'] },
        { id: 'nike-tshirt', name: 'Nike T-shirt', basePrice: 35, colors: ['Navy'], sizes: ['S', 'M', 'L', 'XL', 'XXL', 'XXXL'] },
        { id: 'comfort-crew-sweatshirt', name: 'Comfort Crew Sweatshirt', basePrice: 40, colors: ['Navy', 'White'], sizes: ['S', 'M', 'L', 'XL', 'XXL', 'XXXL'] },
        { id: 'gilden-crew-sweatshirt', name: 'Gilden Crew Sweatshirt', basePrice: 25, colors: ['Navy', 'White'], sizes: ['S', 'M', 'L', 'XL', 'XXL', 'XXXL'] },
        { id: 'nike-crew-sweatshirt', name: 'Nike Crew Sweatshirt', basePrice: 55, colors: ['Navy', 'Gray'], sizes: ['S', 'M', 'L', 'XL', 'XXL', 'XXXL'] },
        { id: 'hooded-sweatshirt', name: 'Hooded Sweatshirt', basePrice: 30, colors: ['Navy', 'White'], sizes: ['S', 'M', 'L', 'XL', 'XXL', 'XXXL'] },
        { id: 'nike-fleece-quarter-zip', name: 'Nike Fleece Quarter Zip', basePrice: 55, colors: ['Navy', 'Gray', 'White'], sizes: ['S', 'M', 'L', 'XL', 'XXL'] },
        { id: 'windbreaker', name: 'Windbreaker', basePrice: 50, colors: ['Navy'], sizes: ['S', 'M', 'L', 'XL'] },
        { id: 'nike-joggers', name: 'Nike Joggers', basePrice: 55, colors: ['Navy', 'Gray'], sizes: ['S', 'M', 'L', 'XL', 'XXL'] },
        { id: 'holloway-joggers', name: 'Holloway Joggers', basePrice: 55, colors: ['Navy', 'Gray'], sizes: ['S', 'M', 'L', 'XL', 'XXL'] },
        { id: 'womens-tank-top', name: 'Womens Tank Top', basePrice: 20, colors: ['Navy'], sizes: ['S', 'M', 'L', 'XL', 'XXL'] },
        { id: 'pajama-pants', name: 'Pajama Pants', basePrice: 25, colors: ['Navy'], sizes: ['S', 'M', 'L', 'XL', 'XXL'] },
        { id: 'microterary-cardigan', name: 'Microterary Cardigan', basePrice: 40, colors: ['Gray', 'Navy'], sizes: ['S', 'M', 'L', 'XL', 'XXL'] },
        { id: 'microfiber-towel', name: 'Microfiber Towel', basePrice: 12, colors: ['Navy'], sizes: ['28x56'] },
        { id: 'car-magnet', name: 'Car Magnet', basePrice: 5, colors: ['N/A'], sizes: ['N/A'] },
        { id: 'chromebook-sticker', name: 'Chromebook Sticker', basePrice: 5, colors: ['N/A'], sizes: ['N/A'] }
      ];

      const itemsById = new Map(ITEMS.map(item => [item.id, item]));

      /** State */
      const order = []; // {item, color, size, qty, priceEach, total}
      function populateItemOptions() {
        itemEl.innerHTML = '';
        ITEMS.forEach((item) => {
          const option = document.createElement('option');
          option.value = item.id;
          option.textContent = `${item.name} ($${item.basePrice.toFixed(2)})`;
          itemEl.appendChild(option);
        });
      }

      function populateSelectOptions(selectEl, values) {
        selectEl.innerHTML = '';
        values.forEach((value) => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          selectEl.appendChild(option);
        });
      }

      function updateDependentSelects() {
        const selectedItem = itemsById.get(itemEl.value) || ITEMS[0];
        if (!selectedItem) {
          colorEl.innerHTML = '';
          sizeEl.innerHTML = '';
          return;
        }
        populateSelectOptions(colorEl, selectedItem.colors);
        populateSelectOptions(sizeEl, selectedItem.sizes);
        colorEl.disabled = selectedItem.colors.length === 1 && selectedItem.colors[0] === 'N/A';
        sizeEl.disabled = selectedItem.sizes.length === 1 && selectedItem.sizes[0] === 'N/A';
      }

      function computePrice(item, size) {
        const surcharge = SURCHARGE_SIZES[size] || 0;
        return item.basePrice + surcharge;
      }

      function buildCSV() {
        const rows = [
          ['Parent Name', parentNameEl.value.trim()],
          ['Swimmer Name(s)', swimmerNamesEl.value.trim()],
          ['Email', emailEl.value.trim()],
          ['Cell', cellEl.value.trim()],
          [],
          ['Item', 'Color', 'Size', 'Qty', 'Price Each', 'Line Total']
        ];
        order.forEach(l =>
          rows.push([l.item, l.color, l.size, String(l.qty), l.priceEach.toFixed(2), l.total.toFixed(2)])
        );
        rows.push([]);
        const grand = order.reduce((s, l) => s + l.total, 0);
        rows.push(['Grand Total', '', '', '', '', grand.toFixed(2)]);

        return rows.map(r =>
          r.map((cell = '') => {
            const needsQuotes = /[",\n]/.test(cell);
            const c = String(cell).replaceAll('"', '""');
            return needsQuotes ? `"${c}"` : c;
          }).join(',')
        ).join('\n');
      }
      async function saveToGitHub() {
        // Placeholder for Save to GitHub logic
        alert('Save to GitHub not implemented.');
      }

      async function saveToDropbox() {
        try {
          if (!parentNameEl.value.trim()) {
            alert('Please enter a parent name at the top.');
            parentNameEl.focus();
            return;
          }
          if (order.length === 0) {
            alert('Please add at least one item to the order.');
            return;
          }
          const csv = buildCSV();
          const fileNameSafe = (parentNameEl.value.trim() || 'order').replace(/[^a-z0-9-_]+/gi, '_');
          const payload = {
            filename: `granville_swim_${fileNameSafe}_${Date.now()}.csv`,
            content: csv
          };
          const ENDPOINT_URL = 'https://swim-order-endpoints.vercel.app/api/save-dropbox';
          console.log('[SaveToDropbox] POST', ENDPOINT_URL, payload);
          const res = await fetch(ENDPOINT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const text = await res.text();
          console.log('[SaveToDropbox] status', res.status, 'body', text);
          if (!res.ok) {
            throw new Error(text || `HTTP ${res.status}`);
          }
          alert('Saved to Dropbox! ✅');
        } catch (err) {
          console.error('[SaveToDropbox] error', err);
          alert('Could not save to Dropbox. Open the browser console for details.');
        }
      }

      function money(n) {
        return `$${(Math.round((n + Number.EPSILON) * 100) / 100).toFixed(2)}`;
      }

      function render() {
        orderBody.innerHTML = '';
        let grand = 0;
        order.forEach((line, idx) => {
          const tr = document.createElement('tr');

          const tdItem = document.createElement('td');
          tdItem.textContent = line.item;

          const tdColor = document.createElement('td');
          tdColor.textContent = line.color;

          const tdSize = document.createElement('td');
          tdSize.textContent = line.size;

          const tdQty = document.createElement('td');
          tdQty.className = 'right';
          tdQty.textContent = line.qty;

          const tdPrice = document.createElement('td');
          tdPrice.className = 'right';
          tdPrice.textContent = money(line.priceEach);

          const tdTotal = document.createElement('td');
          tdTotal.className = 'right';
          tdTotal.textContent = money(line.total);

          const tdRemove = document.createElement('td');
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'link';
          btn.textContent = 'Remove';
          btn.addEventListener('click', () => {
            order.splice(idx, 1);
            render();
          });
          tdRemove.appendChild(btn);

          tr.append(tdItem, tdColor, tdSize, tdQty, tdPrice, tdTotal, tdRemove);
          orderBody.appendChild(tr);

          grand += line.total;
        });
        grandTotalEl.textContent = money(grand);
      }

      function addLine() {
        const selectedItem = itemsById.get(itemEl.value);
        const color = colorEl.value || (colorEl.disabled ? 'N/A' : '');
        const sizeValue = sizeEl.value || (sizeEl.disabled ? 'N/A' : '');
        const qty = parseInt(qtyEl.value, 10);
        const normalizedColor = color || 'N/A';
        const normalizedSize = sizeValue || 'N/A';

        if (!parentNameEl.value.trim()) {
          alert('Please enter a parent name at the top.');
          parentNameEl.focus();
          return;
        }
        if (!selectedItem) {
          alert('Please select a valid item.');
          itemEl.focus();
          return;
        }
        if (!normalizedColor && !colorEl.disabled) {
          alert('Please select a color.');
          colorEl.focus();
          return;
        }
        if (!normalizedSize && !sizeEl.disabled) {
          alert('Please select a size.');
          sizeEl.focus();
          return;
        }
        if (!qty || qty < 1) {
          alert('Quantity must be at least 1.');
          qtyEl.focus();
          return;
        }

        const price = computePrice(selectedItem, normalizedSize);
        const total = price * qty;
        order.push({
          item: selectedItem.name,
          color: normalizedColor,
          size: normalizedSize,
          qty,
          priceEach: price,
          total
        });
        render();
      }

      function resetOrder() {
        if (
          order.length === 0 &&
          !parentNameEl.value.trim() &&
          !swimmerNamesEl.value.trim() &&
          !emailEl.value.trim() &&
          !cellEl.value.trim()
        ) {
          return;
        }
        if (confirm('Clear the contact info and all order lines?')) {
          order.splice(0, order.length);
          parentNameEl.value = '';
          swimmerNamesEl.value = '';
          emailEl.value = '';
          cellEl.value = '';
          if (ITEMS.length > 0) {
            itemEl.value = ITEMS[0].id;
          }
          updateDependentSelects();
          qtyEl.value = 1;
          render();
        }
      }

      function printOrder() {
        window.print();
      }

      populateItemOptions();
      if (ITEMS.length > 0) {
        itemEl.value = ITEMS[0].id;
      }
      updateDependentSelects();

      itemEl.addEventListener('change', updateDependentSelects);
      addBtn.addEventListener('click', addLine);
      resetBtn.addEventListener('click', resetOrder);
      printBtn.addEventListener('click', printOrder);
      saveDropboxBtn.addEventListener('click', saveToDropbox);

      // Basic keyboard support: Enter key on qty adds line
      qtyEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addLine();
        }
      });

      // Initialize
      render();
    })();
  </script>
</body>
</html>
